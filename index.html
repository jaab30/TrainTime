<!doctype <!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Train Time</title>
        <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->

        <!-- Added link to the jQuery Library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <!-- reset css -->
        <link rel="stylesheet" type="text/css" href="assets/css/reset.css" />
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <!-- link to font -->
        <link href="https://fonts.googleapis.com/css?family=Abril+Fatface|Dosis:400,600,700,800|Montserrat:400,500|Raleway:400,500" rel="stylesheet">
        <!-- link to css -->
        <link rel="stylesheet" type="text/css" media="screen" href="assets/css/style.css" />
        <!-- Link to Moment.js -->
        <script src="https://cdn.jsdelivr.net/momentjs/2.12.0/moment.min.js"></script>


    </head>

    <body>
        <main class="container-fluid">
            <div class="jumbotron jumbotron-fluid p-3 mb-2 text-white bg-transparent">
                <div class="container text-center ">
                    <h1 class="display-4 text-center">It's Train Time!</h1>
                    <p class="lead font-weight-light">Find out when your next Train is coming... </p>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2">
                </div>
                <div class="col-sm-8">
                    <div class="card mb-4">
                        <div class="card-header bg-dark text-center text-light mt-2">
                        Current Train Schedule
                        </div>
                        <div class="card-body">
                            <table class="table  table-striped" id="mainTable">
                                <thead>
                                    <tr class="title-row font-weight-bold table-light">
                                        <th>Train Name</th>
                                        <th>Destination</th>
                                        <th>Frequency (min)</th>
                                        <th>Next Arrival</th>
                                        <th>Minutes Away</th>
                                    </tr>
                                </thead>
                                <tbody id="table-results">
                                    
                                </tbody> 
                            </table>
                        </div>
                    </div>
                <div class="col-sm-2">
                </div>
                </div>
            </div>
            <div class="row">
                    <div class="col-sm-4">
                    </div>
                    <div class="col-sm-4">
                        <div class="card mb-5">
                            <div class="card-header bg-dark text-center text-light">
                            Add Train
                            </div>
                            <div class="card-body p-5">
                                <form role="form-group"> 
                                    <div class="form-group row">
                                        <label for="train-input">Train Name</label>
                                        <input class="form-control" id="train-input" type="text" placeholder="Chattanooga Choo Choo">
                                    </div>
                                    <div class="form-group row">
                                        <label for="destination-input">Destination</label>
                                        <input class="form-control" id="destination-input" type="text" placeholder="Miami">
                                    </div>
                                    <div class="form-group row">
                                        <label for="time-input">First Train Time (HH:mm - military) time</label>
                                        <input class="form-control" id="time-input" type="text" placeholder="13:45">
                                    </div>
                                    <div class="form-group row">
                                            <label for="frequency-input">Frequency (min)</label>
                                            <input class="form-control" id="frequency-input" type="number" placeholder="47">
                                    </div>
                                
                                    <button class="btn btn-default bg-secondary text-light" id="add-train" type="submit">Submit</button>
                                </form>
                            </div>
                        </div>
                    </div>
                <div class="col-sm-4">
                </div>
            </div>
        </main>

        <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script>
        <script type="text/javascript">

            var config = {
                apiKey: "AIzaSyCuZUZ8jF_7IpegKWwdNw0Yc5OKFmRXDPY",
                authDomain: "traintime-638d3.firebaseapp.com",
                databaseURL: "https://traintime-638d3.firebaseio.com",
                projectId: "traintime-638d3",
                storageBucket: "traintime-638d3.appspot.com",
                messagingSenderId: "223055511661"
                };

                firebase.initializeApp(config);

            var database = firebase.database();

                            
        $("#add-train").on("click", function(event){
            event.preventDefault();

            var trainName = $("#train-input").val().trim();
            var destination = $("#destination-input").val().trim();
            var time = $("#time-input").val().trim();
            var frequency = $("#frequency-input").val().trim();

            database.ref().push({
                trainName: trainName,
                destination: destination,
                time: time,
                frequency: frequency
            })

            $("#train-input").val("")
            $("#destination-input").val("")
            $("#time-input").val("")
            $("#frequency-input").val("")
        })


        database.ref().on("child_added", function(childresponse) {

            trainName = childresponse.val().trainName,
            destination = childresponse.val().destination,
            time = childresponse.val().time,
            frequency = childresponse.val().frequency

            tableContainer = $("<tr>")
            trainCol = $("<td>")
            destinationCol = $("<td>")
            frequencyCol = $("<td>")
            nextArrivalCol = $("<td>")
            minutesAwayCol = $("<td id='minutes'>")


            trainCol.text(childresponse.val().trainName);
            destinationCol.text(childresponse.val().destination);
            frequencyCol.text(childresponse.val().frequency);
            

            tableContainer.append(trainCol, destinationCol,frequencyCol,nextArrivalCol,minutesAwayCol)
            $("#table-results").append(tableContainer)

            var firstTrainTimeConverted = moment(time, "HH:mm").subtract(1, "years");

            var currentTime = moment();

            var subtTime = moment().diff(moment(firstTrainTimeConverted), "minutes");

            var division = subtTime % frequency;

            var nextArrival = frequency - division;

            var nextTrain = moment().add(nextArrival, "minutes");

            nextArrivalCol.text(moment(nextTrain).format("hh:mm a"));
            minutesAwayCol.text(nextArrival);

        }, function(errorObject) {
        console.log("Errors handled: " + errorObject.code);
        });

        setInterval(update(),10000); 
 
            function update(){
                $('#minutes').load(nextArrival);
            }


        </script>

    </body>
</html>